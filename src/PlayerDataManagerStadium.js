// src/PlayerDataManagerStadium.js - üèüÔ∏è Spr√°va hlavn√≠ho stadionu hr√°ƒçe (UPRAVENO PRO MANU√ÅLN√ç UKL√ÅD√ÅN√ç)
export class PlayerStadiumManager {
    constructor(dataManager) {
      this.dataManager = dataManager;
      
      // üèüÔ∏è Hlavn√≠ stadion hr√°ƒçe
      this.mainStadium = {
        id: 'main',        // V≈ædy 'main' pro hlavn√≠ stadion
        name: 'M≈Øj stadion',
        elements: [],       // Stadium elements
        lastModified: null,
        isDirty: false      // P≈ô√≠znak, ≈æe jsou neulo≈æen√© zmƒõny
      };
      
      // üíæ NOV√â: Pro sledov√°n√≠ zmƒõn
      this.lastSavedElements = JSON.stringify([]);
      
      // U≈æ ≈æ√°dn√Ω auto-save!
      this.isSaving = false;
    }
    
    // üèüÔ∏è Naƒçti nebo vytvo≈ô hlavn√≠ stadion
    async loadOrCreateMainStadium() {
      const firebaseManager = window.firebaseManager;
      const currentUser = firebaseManager?.getCurrentUser();
      
      if (!currentUser) {
        console.warn('‚ö†Ô∏è No user logged in - using local stadium');
        return this.mainStadium.elements;
      }
      
      try {
        console.log('üì• Loading main stadium...');
        const stadiumData = await firebaseManager.loadMainStadium();
        
        if (stadiumData && stadiumData.elements && stadiumData.elements.length > 0) {
          // Stadium existuje a m√° elementy
          this.mainStadium.elements = stadiumData.elements || [];
          this.mainStadium.name = stadiumData.name || 'M≈Øj stadion';
          this.mainStadium.lastModified = stadiumData.lastModified;
          this.mainStadium.isDirty = false;
          
          // üíæ NOV√â: Ulo≈æ jako last saved state
          this.lastSavedElements = JSON.stringify(this.mainStadium.elements);
          
          console.log('‚úÖ Main stadium loaded:', this.mainStadium.elements.length, 'elements');
          return this.mainStadium.elements;
        } else {
          // Stadium neexistuje nebo je pr√°zdn√Ω - NEUKL√ÅDEJ HO!
          console.log('üÜï No stadium found or empty - starting fresh');
          this.mainStadium.elements = [];
          this.mainStadium.isDirty = false;
          this.lastSavedElements = JSON.stringify([]);
          return this.mainStadium.elements;
        }
        
      } catch (error) {
        console.error('‚ùå Failed to load stadium:', error);
        return this.mainStadium.elements;
      }
    }
    
    // üèüÔ∏è Aktualizuj elementy stadionu (BEZ auto-save)
    updateStadiumElements(elements) {
      console.log(`üèüÔ∏è updateStadiumElements called with ${elements?.length || 0} elements`);
      
      // D≈ÆLE≈ΩIT√â: Ujisti se, ≈æe elements je array
      if (!Array.isArray(elements)) {
        console.error('‚ùå updateStadiumElements: elements is not an array!', typeof elements);
        return;
      }
      
      // Porovnej s aktu√°ln√≠mi elementy - pokud jsou jin√©, oznaƒç jako dirty
      const elementsChanged = JSON.stringify(this.mainStadium.elements) !== JSON.stringify(elements);
      
      if (elementsChanged) {
        // Deep copy array
        this.mainStadium.elements = [...elements];
        this.mainStadium.lastModified = new Date();
        this.mainStadium.isDirty = true; // Oznaƒç ≈æe jsou neulo≈æen√© zmƒõny
        
        console.log(`‚úÖ Stadium updated: ${this.mainStadium.elements.length} elements (unsaved changes)`);
        
        // Notify listeners
        this.dataManager.notifyListeners('stadiumElementsChanged', {
          count: this.mainStadium.elements.length,
          lastModified: this.mainStadium.lastModified,
          isDirty: true
        });
      }
    }
    
    // üíæ NOV√Å METODA: Zkontroluj jestli jsou neulo≈æen√© zmƒõny
    hasUnsavedChanges() {
      const currentElements = JSON.stringify(this.mainStadium.elements);
      return currentElements !== this.lastSavedElements;
    }
    
    // üíæ Manu√°ln√≠ ulo≈æen√≠ stadionu (UPRAVENO S EVENT DISPATCHING)
    async saveStadium() {
      if (this.isSaving) {
        console.log('‚è≥ Already saving stadium...');
        return false;
      }
      
      const firebaseManager = window.firebaseManager;
      const currentUser = firebaseManager?.getCurrentUser();
      
      if (!currentUser) {
        console.warn('‚ö†Ô∏è Cannot save stadium - no user logged in');
        return false;
      }
      
      // Neukl√°dej pr√°zdn√Ω stadion
      if (this.mainStadium.elements.length === 0) {
        console.log('‚ö†Ô∏è Not saving empty stadium');
        return false;
      }
      
      this.isSaving = true;
      
      // üíæ Dispatch event ≈æe zaƒç√≠n√° ukl√°d√°n√≠
      window.dispatchEvent(new Event('stadiumSaveStart'));
      
      try {
        console.log('üíæ Manually saving stadium...', this.mainStadium.elements.length, 'elements');
        
        // üîß D≈ÆLE≈ΩIT√â: Vyƒçisti elementy p≈ôed ulo≈æen√≠m
        const cleanedElements = this.cleanStadiumElementsForFirebase(this.mainStadium.elements);
        
        await firebaseManager.saveMainStadium(
          this.mainStadium.name,
          cleanedElements  // Po≈°li vyƒçi≈°tƒõn√© elementy
        );
        
        console.log('‚úÖ Stadium saved successfully');
        this.mainStadium.isDirty = false; // Vyma≈æ p≈ô√≠znak neulo≈æen√Ωch zmƒõn
        
        // üíæ NOV√â: Aktualizuj lastSavedElements
        this.lastSavedElements = JSON.stringify(this.mainStadium.elements);
        
        // üîß D≈ÆLE≈ΩIT√â: Ulo≈æ tak√© hlavn√≠ player data
        // Stadium se ukl√°d√° separ√°tnƒõ, ale chceme synchronizovat i ostatn√≠ data
        if (this.dataManager.firebaseManager) {
          console.log('üíæ Saving player data alongside stadium...');
          await this.dataManager.firebaseManager.saveToFirebase();
        }
        
        // üíæ Dispatch event ≈æe ukl√°d√°n√≠ bylo dokonƒçeno
        window.dispatchEvent(new Event('stadiumSaveComplete'));
        
        // Notify UI
        if (window.showGameMessage) {
          window.showGameMessage('üíæ Stadion ulo≈æen!', 'success', 2000);
        }
        
        this.dataManager.notifyListeners('stadiumSaved', {
          id: this.mainStadium.id,
          elementCount: this.mainStadium.elements.length
        });
        
        return true;
        
      } catch (error) {
        console.error('‚ùå Failed to save stadium:', error);
        
        // üíæ Dispatch event ≈æe ukl√°d√°n√≠ selhalo
        window.dispatchEvent(new Event('stadiumSaveError'));
        
        if (window.showGameMessage) {
          window.showGameMessage('‚ùå Chyba p≈ôi ukl√°d√°n√≠', 'error', 2000);
        }
        return false;
      } finally {
        this.isSaving = false;
      }
    }
    
    // üîß NOV√Å METODA: Vyƒçisti stadium elementy pro Firebase
    cleanStadiumElementsForFirebase(elements) {
      if (!Array.isArray(elements)) {
        console.error('‚ùå cleanStadiumElementsForFirebase: elements is not an array');
        return [];
      }
      
      return elements.map(element => {
        try {
          // Vytvo≈ô ƒçistou kopii bez Three.js objekt≈Ø
          const cleaned = {
            // Z√°kladn√≠ properties
            id: element.id,
            type: element.type,
            
            // P≈ôeveƒè position na prost√Ω objekt
            position: element.position ? {
              x: typeof element.position.x === 'number' ? element.position.x : 0,
              y: typeof element.position.y === 'number' ? element.position.y : 0,
              z: typeof element.position.z === 'number' ? element.position.z : 0
            } : { x: 0, y: 0, z: 0 },
            
            // Z√°kladn√≠ transformace
            rotation: typeof element.rotation === 'number' ? element.rotation : 0,
            scale: typeof element.scale === 'number' ? element.scale : 1,
            
            // Economy properties
            purchasePrice: element.purchasePrice,
            purchaseCurrency: element.purchaseCurrency,
            
            // Seat properties
            seatOptions: element.seatOptions ? {
              type: element.seatOptions.type,
              color: element.seatOptions.color,
              placementMode: element.seatOptions.placementMode
            } : undefined,
            seatCount: element.seatCount,
            parentStairsId: element.parentStairsId,
          };
          
          // P≈ôidej specifick√© vlastnosti podle typu
          if (element.type === 'single_seats' || element.type === 'seat_row') {
            if (typeof element.stepIndex === 'number') cleaned.stepIndex = element.stepIndex;
            if (typeof element.rowIndex === 'number') cleaned.rowIndex = element.rowIndex;
            if (typeof element.seatIndex === 'number') cleaned.seatIndex = element.seatIndex;
          }
          
          if (element.type === 'curved_stairs' || element.type === 'concrete_stairs') {
            if (typeof element.angle === 'number') cleaned.angle = element.angle;
            if (element.direction) cleaned.direction = element.direction;
            if (element.pivotPosition) cleaned.pivotPosition = element.pivotPosition;
            if (typeof element.sideSteps === 'number') cleaned.sideSteps = element.sideSteps;
          }
          
          // Stand properties
          if (element.type && element.type.includes('stand')) {
            if (element.variant) cleaned.variant = element.variant;
            if (typeof element.capacity === 'number') cleaned.capacity = element.capacity;
          }
          
          // Odstra≈à undefined hodnoty
          Object.keys(cleaned).forEach(key => {
            if (cleaned[key] === undefined) {
              delete cleaned[key];
            }
          });
          
          return cleaned;
          
        } catch (error) {
          console.error('‚ùå Error cleaning element:', element.id, error);
          // Vra≈• alespo≈à z√°kladn√≠ info
          return {
            id: element.id || 'unknown',
            type: element.type || 'unknown',
            position: { x: 0, y: 0, z: 0 },
            rotation: 0
          };
        }
      });
    }
    
    // üèüÔ∏è Vyma≈æ stadion
    clearStadium() {
      console.log('üóëÔ∏è Clearing stadium...');
      this.mainStadium.elements = [];
      this.mainStadium.lastModified = new Date();
      this.mainStadium.isDirty = true;
      
      // Notify listeners
      this.dataManager.notifyListeners('stadiumElementsChanged', {
        count: 0,
        lastModified: this.mainStadium.lastModified,
        isDirty: true
      });
    }
    
    // üìä Gettery
    getStadiumInfo() {
      return {
        id: this.mainStadium.id,
        name: this.mainStadium.name,
        elementCount: this.mainStadium.elements.length,
        lastModified: this.mainStadium.lastModified,
        isSaving: this.isSaving,
        hasUnsavedChanges: this.hasUnsavedChanges() // üíæ UPRAVENO: volej metodu
      };
    }
    
    // üíæ Export/Import
    exportData() {
      return {
        mainStadium: {
          name: this.mainStadium.name,
          // üíæ NOV√â: P≈ôidej lastSavedElements do exportu
          lastSavedElements: this.lastSavedElements
          // Elementy se naƒçtou z Firebase, neexportujeme je
        }
      };
    }
    
    importData(data) {
      if (data.mainStadium) {
        this.mainStadium.name = data.mainStadium.name || this.mainStadium.name;
        // üíæ NOV√â: Import lastSavedElements pokud existuje
        if (data.mainStadium.lastSavedElements) {
          this.lastSavedElements = data.mainStadium.lastSavedElements;
        }
      }
    }
    
    // üßπ Cleanup
    dispose() {
      // U≈æ ≈æ√°dn√Ω auto-save timeout k vyƒçi≈°tƒõn√≠
      console.log('üßπ Stadium manager disposed');
    }
  }